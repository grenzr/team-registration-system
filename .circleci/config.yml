version: 2

jobs:
  build:
    machine: true
    steps:

      - checkout

      - run:
          name: "Copy .env"
          command: "cp .env.dist .env"

      - run:
          name: "Copy JWT certificate"
          command: "cp ssl/jwt.dist/* ssl/jwt"

      - run:
          name: "Build"
          command: "bin/build"

      - run:
          name: "Correct JWT certificate permissions"
          command: "docker-compose exec php chgrp www-data ssl/jwt/private.pem && docker-compose exec php chmod 750 ssl/jwt/private.pem"

      - run:
          name: "Run PHPUnit"
          command: "docker-compose exec php vendor/bin/phpunit --log-junit .circleci/test-results/phpunit/results.xml"

      - run:
          name: "Run Behat"
          command: "docker-compose exec php vendor/bin/behat --format junit --out .circleci/test-results/behat --format pretty --out std"

      - run:
          name: "Code Sniffer (PSR-2 Coding Standards)"
          command: "docker-compose exec php vendor/bin/phpcs --standard=PSR2 --ignore=/Migrations/ src"

      - store_test_results:
          path: ".circleci/test-results"
