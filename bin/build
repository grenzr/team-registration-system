#!/usr/bin/env sh
docker run --env-file=.env -it --rm -v $PWD:/usr/src/app -w /usr/src/app node:9.11.1 yarn install \
&& docker run --env-file=.env -it --rm -v $PWD:/usr/src/app -w /usr/src/app node:9.11.1 yarn run encore production \
&& docker-compose up -d \
&& docker-compose exec php sh -c 'composer install $([ "$APP_ENV" = "dev" ] || echo "--no-dev")' \
&& docker-compose exec php bin/console doctrine:migrations:migrate -n \
&& docker-compose exec php chgrp www-data ssl/jwt/private.pem \
&& docker-compose exec php chmod 750 ssl/jwt/private.pem